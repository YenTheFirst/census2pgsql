geo_file_def = [{"id"=>"FILEID", "type"=>"Text", "len"=>6},
 {"id"=>"STUSAB", "type"=>"Text", "len"=>2},
 {"id"=>"SUMLEV", "type"=>"Text", "len"=>3},
 {"id"=>"GEOCOMP", "type"=>"Text", "len"=>2},
 {"id"=>"CHARITER", "type"=>"Text", "len"=>3},
 {"id"=>"CIFSN", "type"=>"Text", "len"=>2},
 {"id"=>"LOGRECNO", "type"=>"Text", "len"=>7},
 {"id"=>"REGION", "type"=>"Text", "len"=>1},
 {"id"=>"DIVISION", "type"=>"Text", "len"=>1},
 {"id"=>"STATE", "type"=>"Text", "len"=>2},
 {"id"=>"COUNTY", "type"=>"Text", "len"=>3},
 {"id"=>"COUNTYCC", "type"=>"Text", "len"=>2},
 {"id"=>"COUNTYSC", "type"=>"Text", "len"=>2},
 {"id"=>"COUSUB", "type"=>"Text", "len"=>5},
 {"id"=>"COUSUBCC", "type"=>"Text", "len"=>2},
 {"id"=>"COUSUBSC", "type"=>"Text", "len"=>2},
 {"id"=>"PLACE", "type"=>"Text", "len"=>5},
 {"id"=>"PLACECC", "type"=>"Text", "len"=>2},
 {"id"=>"PLACESC", "type"=>"Text", "len"=>2},
 {"id"=>"TRACT", "type"=>"Text", "len"=>6},
 {"id"=>"BLKGRP", "type"=>"Text", "len"=>1},
 {"id"=>"BLOCK", "type"=>"Text", "len"=>4},
 {"id"=>"IUC", "type"=>"Text", "len"=>2},
 {"id"=>"CONCIT", "type"=>"Text", "len"=>5},
 {"id"=>"CONCITCC", "type"=>"Text", "len"=>2},
 {"id"=>"CONCITSC", "type"=>"Text", "len"=>2},
 {"id"=>"AIANHH", "type"=>"Text", "len"=>4},
 {"id"=>"AIANHHFP", "type"=>"Text", "len"=>5},
 {"id"=>"AIANHHCC", "type"=>"Text", "len"=>2},
 {"id"=>"AIHHTLI", "type"=>"Text", "len"=>1},
 {"id"=>"AITSCE", "type"=>"Text", "len"=>3},
 {"id"=>"AITS", "type"=>"Text", "len"=>5},
 {"id"=>"AITSCC", "type"=>"Text", "len"=>2},
 {"id"=>"TTRACT", "type"=>"Text", "len"=>6},
 {"id"=>"TBLKGRP", "type"=>"Text", "len"=>1},
 {"id"=>"ANRC", "type"=>"Text", "len"=>5},
 {"id"=>"ANRCCC", "type"=>"Text", "len"=>2},
 {"id"=>"CBSA", "type"=>"Text", "len"=>5},
 {"id"=>"CBSASC", "type"=>"Text", "len"=>2},
 {"id"=>"METDIV", "type"=>"Text", "len"=>5},
 {"id"=>"CSA", "type"=>"Text", "len"=>3},
 {"id"=>"NECTA", "type"=>"Text", "len"=>5},
 {"id"=>"NECTASC", "type"=>"Text", "len"=>2},
 {"id"=>"NECTADIV", "type"=>"Text", "len"=>5},
 {"id"=>"CNECTA", "type"=>"Text", "len"=>3},
 {"id"=>"CBSAPCI", "type"=>"Text", "len"=>1},
 {"id"=>"NECTAPCI", "type"=>"Text", "len"=>1},
 {"id"=>"UA", "type"=>"Text", "len"=>5},
 {"id"=>"UASC", "type"=>"Text", "len"=>2},
 {"id"=>"UATYPE", "type"=>"Text", "len"=>1},
 {"id"=>"UR", "type"=>"Text", "len"=>1},
 {"id"=>"CD", "type"=>"Text", "len"=>2},
 {"id"=>"SLDU", "type"=>"Text", "len"=>3},
 {"id"=>"SLDL", "type"=>"Text", "len"=>3},
 {"id"=>"VTD", "type"=>"Text", "len"=>6},
 {"id"=>"VTDI", "type"=>"Text", "len"=>1},
 {"id"=>"RESERVE2", "type"=>"Text", "len"=>3},
 {"id"=>"ZCTA5", "type"=>"Text", "len"=>5},
 {"id"=>"SUBMCD", "type"=>"Text", "len"=>5},
 {"id"=>"SUBMCDCC", "type"=>"Text", "len"=>2},
 {"id"=>"SDELM", "type"=>"Text", "len"=>5},
 {"id"=>"SDSEC", "type"=>"Text", "len"=>5},
 {"id"=>"SDUNI", "type"=>"Text", "len"=>5},
 {"id"=>"AREALAND", "type"=>"Text", "len"=>14},
 {"id"=>"AREAWATR", "type"=>"Text", "len"=>14},
 {"id"=>"NAME", "type"=>"Text", "len"=>90},
 {"id"=>"FUNCSTAT", "type"=>"Text", "len"=>1},
 {"id"=>"GCUNI", "type"=>"Text", "len"=>1},
 {"id"=>"POP100", "type"=>"Text", "len"=>9},
 {"id"=>"HU100", "type"=>"Text", "len"=>9},
 {"id"=>"INTPTLAT", "type"=>"Float", "len"=>11},
 {"id"=>"INTPTLON", "type"=>"Float", "len"=>12},
 {"id"=>"LSADC", "type"=>"Text", "len"=>2},
 {"id"=>"PARTFLAG", "type"=>"Text", "len"=>1},
 {"id"=>"RESERVE3", "type"=>"Text", "len"=>6},
 {"id"=>"UGA", "type"=>"Text", "len"=>5},
 {"id"=>"STATENS", "type"=>"Text", "len"=>8},
 {"id"=>"COUNTYNS", "type"=>"Text", "len"=>8},
 {"id"=>"COUSUBNS", "type"=>"Text", "len"=>8},
 {"id"=>"PLACENS", "type"=>"Text", "len"=>8},
 {"id"=>"CONCITNS", "type"=>"Text", "len"=>8},
 {"id"=>"AIANHHNS", "type"=>"Text", "len"=>8},
 {"id"=>"AITSNS", "type"=>"Text", "len"=>8},
 {"id"=>"ANRCNS", "type"=>"Text", "len"=>8},
 {"id"=>"SUBMCDNS", "type"=>"Text", "len"=>8},
 {"id"=>"CD113", "type"=>"Text", "len"=>2},
 {"id"=>"CD114", "type"=>"Text", "len"=>2},
 {"id"=>"CD115", "type"=>"Text", "len"=>2},
 {"id"=>"SLDU2", "type"=>"Text", "len"=>3},
 {"id"=>"SLDU3", "type"=>"Text", "len"=>3},
 {"id"=>"SLDU4", "type"=>"Text", "len"=>3},
 {"id"=>"SLDL2", "type"=>"Text", "len"=>3},
 {"id"=>"SLDL3", "type"=>"Text", "len"=>3},
 {"id"=>"SLDL4", "type"=>"Text", "len"=>3},
 {"id"=>"AIANHHSC", "type"=>"Text", "len"=>2},
 {"id"=>"CSASC", "type"=>"Text", "len"=>2},
 {"id"=>"CNECTASC", "type"=>"Text", "len"=>2},
 {"id"=>"MEMI", "type"=>"Text", "len"=>1},
 {"id"=>"NMEMI", "type"=>"Text", "len"=>1},
 {"id"=>"PUMA", "type"=>"Text", "len"=>5},
 {"id"=>"RESERVED", "type"=>"Text", "len"=>18}
]
pos=0
precomputed_ranges=geo_file_def.map do |d|
	start=pos
	last = pos+d["len"]-1
	pos=last+1
	[start,last]
end

states = ['ak', 'al', 'ar', 'az', 'ca', 'co', 'ct', 'dc', 'de', 'fl', 'ga', 'hi', 'la', 'id', 'il', 'in', 'ks', 'ky', 'la', 'ma', 'md', 'me', 'mi', 'mn', 'mo', 'ms', 'mt', 'nc', 'nd', 'ne', 'nh', 'nj', 'nm', 'nv', 'ny', 'oh', 'ok', 'or', 'pa', 'pr', 'ri', 'sc', 'sd', 'tn', 'tx', 'ut', 'va', 'vt', 'wa', 'wi', 'wv', 'wy']

DELIM = '|'

def parse_geo(line, field_ranges)
  
  vals = field_ranges.map do |(start,last)|
    line[start..last].strip
  end
  
  vals.join(DELIM)
end

def trim_dup_cols(line)
  line.chomp.split(',')[5..-1].join(DELIM)
end

DATA_DIR = '../data/'

states.each do |state| 
  geo_filename = "#{DATA_DIR}/#{state}geo2010.pl"
  pt1_filename = "#{DATA_DIR}/#{state}000012010.pl"
  pt2_filename = "#{DATA_DIR}/#{state}000022010.pl"
  
  unless File.readable?(geo_filename) && File.readable?(pt1_filename) && File.readable?(pt2_filename)
    puts "#{state} (skipping)"
  else
    puts "#{state}"
    
    geo_file = File.new(geo_filename, "r")
    pt1_file = File.new(pt1_filename, "r")
    pt2_file = File.new(pt2_filename, "r")
    out_file = File.new("#{DATA_DIR}/#{state}_merged.csv", "w")

    geo_file.each do |geo_line|
      pt1_line = pt1_file.readline()
      pt2_line = pt2_file.readline()

      out_file << parse_geo(geo_line, precomputed_ranges) << DELIM << trim_dup_cols(pt1_line) << DELIM << trim_dup_cols(pt2_line) << "\n"
    end

    geo_file.close
    pt1_file.close
    pt2_file.close
    out_file.close
  end

end